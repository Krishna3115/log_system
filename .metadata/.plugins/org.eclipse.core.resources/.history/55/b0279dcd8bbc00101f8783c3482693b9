package com.call_logs.system.service;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.stereotype.Service;

import com.call_logs.system.dto.CallLogRequest;
import com.call_logs.system.dto.EmployeeDispatchRequest;
import com.call_logs.system.dto.PartRequest;
import com.call_logs.system.dto.QueryRequest;
import com.call_logs.system.dto.SystemReceiveRequest;
import com.call_logs.system.entity.CallLog;
import com.call_logs.system.entity.CallLogQuery;
import com.call_logs.system.entity.Part;
import com.call_logs.system.entity.User;
import com.call_logs.system.enums.Status;
import com.call_logs.system.repository.CallLogQueryRepository;
import com.call_logs.system.repository.CallLogRepository;
import com.call_logs.system.repository.PartRepository;
import com.call_logs.system.repository.UserRepository;

@Service
public class CallLogServiceImpl implements CallLogService {

	 @Autowired
	    private CallLogRepository callLogRepository;

	    @Autowired
	    private UserRepository userRepository;
	    
	    @Autowired
	    private CallLogQueryRepository callLogQueryRepository;
	    
	    @Autowired
	    private PartRepository partRepository;


	    @Override
	    public CallLog createCallLog(CallLogRequest request) {
	        User receivedBy = userRepository.findById(request.getReceivedBy())
	                .orElseThrow(() -> new RuntimeException("User not found"));

	        CallLog callLog = new CallLog();
	        callLog.setCustomerName(request.getCustomerName());
	        callLog.setMobileNumber(request.getMobileNumber());
	        callLog.setDateTime(LocalDateTime.now());
	        callLog.setSystemType(request.getSystemType());
	        callLog.setDescription(request.getDescription());
	        callLog.setReceivedBy(receivedBy);
	        callLog.setStatus(Status.PENDING);

	        return callLogRepository.save(callLog);
	    }

	    @Override
	    public List<CallLog> getAllLogs() {
	        return callLogRepository.findAll();
	    }

	    @Override
	    public List<CallLog> getLogsByUser(Long userId) {
	        User user = userRepository.findById(userId)
	                .orElseThrow(() -> new RuntimeException("User not found"));

	        return callLogRepository.findByReceivedBy(user);
	    }

	    @Override
	    public CallLog updateStatus(Long callLogId, Status status) {
	        CallLog callLog = callLogRepository.findById(callLogId)
	                .orElseThrow(() -> new RuntimeException("Call log not found"));

	        callLog.setStatus(status);
	        return callLogRepository.save(callLog);
	    }

	    @Override
	    public List<CallLog> getLogsByStatus(Status status) {
	        return callLogRepository.findByStatus(status);
	    }

	    @Override
	    public CallLog assignEmployee(Long id, EmployeeDispatchRequest request) {
	        CallLog callLog = callLogRepository.findById(id)
	            .orElseThrow(() -> new RuntimeException("CallLog not found"));

	        User employee = userRepository.findById(request.getAssignedEmployeeId())
	            .orElseThrow(() -> new RuntimeException("Assigned employee not found"));

	        callLog.setCustomerName(request.getCustomerName());
	        callLog.setMobileNumber(request.getMobileNumber());
	        callLog.setAddress(request.getAddress());
	        callLog.setAssignedEmployee(employee);
	        callLog.setStatus(Status.DISPATCHED); // Set appropriate status

	        return callLogRepository.save(callLog);
	    }

	    @Override
	    public CallLog receiveInOffice(Long id, SystemReceiveRequest request) {
	        CallLog callLog = callLogRepository.findById(id)
	            .orElseThrow(() -> new RuntimeException("CallLog not found"));

	        Long receiverId = Long.parseLong(request.getReceivedBy());
	        User receiver = userRepository.findById(receiverId)
	            .orElseThrow(() -> new RuntimeException("Receiver not found"));

	        callLog.setReceivedBy(receiver);
	        callLog.setStatus(Status.RECEIVED_IN_OFFICE);

	        // Assuming callLog has these fields and setters
	        callLog.setSystemNumber(request.getSystemNumber());
	        callLog.setReceivedAccessories(request.getReceivedAccessories());

	        // Parse date and time from String to LocalDate and LocalTime (adjust format if necessary)
	        callLog.setDeliveryDate(LocalDate.parse(request.getDeliveryDate()));
	        callLog.setDeliveryTime(LocalTime.parse(request.getDeliveryTime()));

	        return callLogRepository.save(callLog);
	    }

	    @Override
	    public CallLogQuery addQuery(Long callLogId, QueryRequest req) {
	        CallLog callLog = callLogRepository.findById(callLogId)
	            .orElseThrow(() -> new RuntimeException("Call log not found with ID: " + callLogId));

	        CallLogQuery query = new CallLogQuery();
	        query.setCallLog(callLog);
	        query.setDescription(req.getDescription());
	        query.setCreatedAt(LocalDateTime.now());

	        return callLogQueryRepository.save(query);
	    }

    
	 // service/CallLogService.java
	    @Override
	    public void addPart(Long systemId, PartRequest request) {
	        Optional<CallLog> optionalCallLog = callLogRepository.findById(systemId);
	        if (!optionalCallLog.isPresent()) {
	            throw new RuntimeException("CallLog not found with ID: " + systemId);
	        }

	        CallLog callLog = optionalCallLog.get();

	        Part part = new Part();
	        part.setPartName(request.getPartName());
	        part.setAvailable(request.isAvailable());
	        part.setCallLog(callLog);

	        partRepository.save(part);
	    }

	    @Override
	    public CallLog completeWork(Long id, String workDescription, Double totalBillAmount, String customerEmail) {
	        CallLog callLog = callLogRepository.findById(id)
	                .orElseThrow(() -> new RuntimeException("Call log not found with id: " + id));

	        callLog.setWorkDescription(workDescription);
	        callLog.setTotalBillAmount(totalBillAmount);
	        callLog.setCustomerEmail(customerEmail);  // ✅ Ensure this field exists and is not null
	        callLog.setStatus(Status.BILL_PENDING);

	        sendBillEmail(callLog);  // ✅ Send after values are saved
	        return callLogRepository.save(callLog);
	    }


	    
	    private void sendBillEmail(CallLog callLog) {
	        SimpleMailMessage message = new SimpleMailMessage();
	        message.setTo(callLog.getCustomerEmail());
	        message.setSubject("Service Bill for System: " + callLog.getSystemNumber());
	        message.setText(
	                "Dear " + callLog.getCustomerName() + ",\n\n" +
	                "Your system repair has been completed.\n" +
	                "Work Description: " + callLog.getWorkDescription() + "\n" +
	                "Total Bill Amount: ₹" + callLog.getTotalBillAmount() + "\n\n" +
	                "Status: BILL_PENDING\n\n" +
	                "Thank you for choosing our service.\n\nBest Regards,\nService Team"
	        );
	        mailSender.send(message);
	    }



}
